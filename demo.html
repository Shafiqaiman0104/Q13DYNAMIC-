<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q13 DYNAMIC - Premium Fireworks</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (ALL YOUR EXISTING CSS STYLES REMAIN EXACTLY THE SAME) ... */
    </style>
</head>
<body>
<!-- Splash Screen -->
<div class="splash-screen" id="splash-screen">
    <!-- ... (splash screen content remains the same) ... -->
</div>

<!-- Spin Wheel Modal -->
<div class="wheel-container" id="wheel-container">
    <!-- ... (spin wheel content remains the same) ... -->
</div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <!-- ... (header content remains the same) ... -->
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <!-- ... (hero content remains the same) ... -->
        </div>
    </section>

<!-- Track Order Section -->
<section id="track-order" style="padding: 60px 0; background: #f8fafc; display: none;">
    <!-- ... (track order content remains the same) ... -->
</section>

<!-- Agent Section -->
<section id="agent" style="padding: 60px 0; background: #f8fafc; display: none;">
    <!-- ... (agent content remains the same) ... -->
</section>

    <!-- Filter Section -->
    <div class="container">
        <!-- ... (filter section content remains the same) ... -->
    </div>

    <!-- Stats Bar -->
    <div class="container">
        <!-- ... (stats bar content remains the same) ... -->
    </div>

    <!-- View Toggle -->
    <div class="container view-toggle">
        <!-- ... (view toggle content remains the same) ... -->
    </div>

    <!-- Catalog Cards Grid -->
    <section class="container">
        <div class="catalog-grid" id="catalog-container">
            <!-- ... (catalog grid content remains the same) ... -->
        </div>
    </section>

    <!-- Video Modal -->
    <div class="video-modal" id="video-modal">
        <!-- ... (video modal content remains the same) ... -->
    </div>

    <!-- Order Modal -->
    <div class="order-modal" id="order-modal">
        <div class="order-modal-content">
            <div class="order-modal-header">
                <h3 class="order-modal-title">Order Fireworks</h3>
                <button class="close-order-modal" id="close-order-modal">&times;</button>
            </div>
            
            <div class="order-details">
                <h4>Order Summary</h4>
                <div class="order-item">
                    <span class="order-label">Product:</span>
                    <span class="order-value" id="order-product-name">-</span>
                </div>
                <div class="order-item">
                    <span class="order-label">Product Price:</span>
                    <span class="order-value" id="order-product-price">RM 0</span>
                </div>
                <div class="order-item">
                    <span class="order-label">Postage Fee:</span>
                    <span class="order-value" id="order-postage-fee">RM 0</span>
                </div>
                <div class="order-item">
                    <span class="order-label">Minimum Order (MOQ):</span>
                    <span class="order-value" id="order-moq">-</span>
                </div>
                <div class="order-item">
                    <span class="order-label">Quantity:</span>
                    <div class="quantity-controls" style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" class="quantity-btn" id="decrease-qty" style="width: 30px; height: 30px; border-radius: 50%; background: var(--gray); border: none; cursor: pointer;">-</button>
                        <input type="number" id="product-quantity" value="1" min="1" max="10" style="width: 60px; text-align: center; padding: 5px; border: 2px solid var(--gray); border-radius: 8px;">
                        <button type="button" class="quantity-btn" id="increase-qty" style="width: 30px; height: 30px; border-radius: 50%; background: var(--gray); border: none; cursor: pointer;">+</button>
                    </div>
                </div>
                <div class="order-item total-price">
                    <span class="order-label">Total Price:</span>
                    <span class="order-value" id="order-total-price">RM 0</span>
                </div>
            </div>
            
            <div class="cod-charge-info">
                <strong>üîî INFORMATION :</strong><br>
                <strong>üì¶ Estimated goods arrive in 2 to 5 working days</strong><br>
                <strong>‚ùå No Refund</strong><br>
                Need help? Please Contact : üìû<strong>60198428621</strong>
            </div>
                        
            <form id="order-form">
                <div class="form-group">
                    <label for="customer-name">Full Name *</label>
                    <input type="text" id="customer-name" class="form-control" required placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="customer-phone">Phone Number *</label>
                    <input type="tel" id="customer-phone" class="form-control" required placeholder="Enter your phone number">
                </div>
                
                <div class="form-group">
                    <label for="customer-email">Email Address *</label>
                    <input type="email" id="customer-email" class="form-control" required placeholder="Enter your email address">
                </div>
                
                <div class="form-group">
                    <label for="delivery-address">Delivery Address *</label>
                    <textarea id="delivery-address" class="form-control" rows="3" required placeholder="Enter complete delivery address including city, state and postcode"></textarea>  
                </div>

                <div class="form-group">
                    <label for="customer-note">Special Request / Note (Optional)</label>
                    <textarea id="customer-note" class="form-control" rows="3" placeholder="Any special instructions, requests, or notes for your order..."></textarea>
                </div>

                <div class="form-group">
                    <label for="discount-code">Discount Code (Optional)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="discount-code" class="form-control" 
                               placeholder="Enter agent discount code" 
                               style="flex: 1;">
                        <button type="button" class="filter-btn" id="apply-discount-btn" 
                                style="white-space: nowrap; background-color: var(--primary); color: white;">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--dark-gray); margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> If you have a discount code from an agent, enter it here.
                    </p>
                </div>

                <!-- ADDED: Terms & Conditions Checkbox for Order Form -->
                <div class="terms-checkbox" id="order-terms-checkbox">
                    <input type="checkbox" id="agree-terms" name="agree-terms" required>
                    <label for="agree-terms">
                        I have read and agree to the <a href="#terms" onclick="openTermsSection('order')">Terms & Conditions</a> of Q13 DYNAMIC.
                    </label>
                </div>
                
                <div class="order-buttons">
                    <button type="submit" class="submit-order-btn" id="submit-order-btn">
                        <i class="fas fa-shopping-cart"></i> Submit Order to WhatsApp
                    </button>
                    <button type="button" class="cancel-order-btn" id="cancel-order-btn">Cancel Order</button>
                </div>
            </form>
        </div>
    </div>

<!-- Star Rating Stats Modal -->
<div class="stats-modal" id="stats-modal">
    <!-- ... (stats modal content remains the same) ... -->
</div>

<!-- Loading Popup -->
<div class="loading-popup" id="loading-popup">
    <div class="loading-popup-content">
        <i class="fas fa-spinner fa-spin"></i>
        <h4>Processing Order</h4>
        <p>Please wait while we prepare your order...</p>
    </div>
</div>

<!-- Terms & Conditions Section -->
<section id="terms" style="padding: 60px 0; background: #f8fafc; display: none;">
    <!-- ... (terms content remains the same) ... -->
</section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <!-- ... (footer content remains the same) ... -->
            </div>
        </div>
    </footer>

    <script>
        // Your Apps Script URL
        const PRODUCT_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbz1tnkvEKaOIi2k76YVws_OiItN8LJ_EMtv1VPkghOu71NJwlCDEBocIw2sneQE7xSRZQ/exec';

        // CHANGE THIS: Updated Order Database URL
        const ORDER_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbxhuHO7-6fGOIS-BF9kUYHIBNzPVspo3MTyRIZvZnRY0WzuYOavP_gPoG_OJyuTShPq/exec';

        // AGENT FORM FUNCTIONS
        const AGENT_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbwL86AaXKMwV7FBIQMcXCTt9qlCHDvi2Ftqzr-u5ePJGdgzMqqVWFQwdbXMRET8cldY/exec';
       
        // Global variables
        let fireworksData = [];
        let filteredData = [];
        let currentOrderProduct = null;

        // Add these global variables at the top with other global variables
        let currentDiscountCode = '';
        let currentAgentId = '';
        let discountCodeApplied = false;
        const DISCOUNT_AMOUNT = 5; // RM5 discount

        // Global variables to store min/max values
        let minSize = Infinity, maxSize = 0;
        let minDuration = Infinity, maxDuration = 0;
        let minShot = Infinity, maxShot = 0;
        
        // DOM elements
        const catalogContainer = document.getElementById("catalog-container");
        const totalCountElement = document.getElementById("total-count");
        const avgShotElement = document.getElementById("avg-shot");
        const avgDurationElement = document.getElementById("avg-duration");
        const filteredCountElement = document.getElementById("filtered-count");
        
        // Filter elements
        const shotFilter = document.getElementById("shot-filter");
        const styleFilter = document.getElementById("style-filter");
        const inchFilter = document.getElementById("inch-filter");
        const durationFilter = document.getElementById("duration-filter");
        const priceFilter = document.getElementById("price-filter");
        const starFilter = document.getElementById('star-filter');
        const applyFiltersBtn = document.getElementById("apply-filters");
        const resetFiltersBtn = document.getElementById("reset-filters");
        
        // Modal elements
        const videoModal = document.getElementById("video-modal");
        const modalVideo = document.getElementById("modal-video");
        const modalTitle = document.getElementById("modal-title");
        const closeModalBtn = document.getElementById("close-modal");
        
        // Order modal elements
        const orderModal = document.getElementById("order-modal");
        const orderProductName = document.getElementById("order-product-name");
        const orderProductPrice = document.getElementById("order-product-price");
        const orderTotalPrice = document.getElementById("order-total-price");
        const orderForm = document.getElementById("order-form");
        const submitOrderBtn = document.getElementById("submit-order-btn");
        const cancelOrderBtn = document.getElementById("cancel-order-btn");
        const closeOrderModalBtn = document.getElementById("close-order-modal");
        
        // View toggle elements
        const gridViewBtn = document.getElementById("grid-view");
        const listViewBtn = document.getElementById("list-view");

        // Navigation functionality
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.querySelector('.nav-menu');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = {
            home: document.querySelector('.hero'),
            trackOrder: document.getElementById('track-order'),
            agent: document.getElementById('agent'),
            terms: document.getElementById('terms'),
            mainContent: document.querySelectorAll('.filter-section, .stats-bar, .view-toggle, #catalog-container')
        };

        // WhatsApp number (YOUR NUMBER)
        const WHATSAPP_NUMBER = '601160801477'; // CHANGE THIS TO YOUR WHATSAPP NUMBER

        // Initialize - hide all non-home sections on load
        function initializeSections() {
            sections.trackOrder.style.display = 'none';
            sections.agent.style.display = 'none';
            sections.terms.style.display = 'none';
            // Show main content
            showMainContent();
        }

        function showMainContent() {
            sections.home.style.display = 'block';
            sections.mainContent.forEach(el => {
                if (el) el.style.display = '';
            });
        }

        function hideMainContent() {
            sections.home.style.display = 'none';
            sections.mainContent.forEach(el => {
                if (el) el.style.display = 'none';
            });
        }

        // Show/hide sections based on navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default anchor behavior
                
                // Update active state
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                link.classList.add('active');
                
                // Close mobile menu
                closeMobileMenu();
                
                const href = link.getAttribute('href');
                
                // Handle different navigation links
                if (href === '#') {
                    // Home - show main content, hide other sections
                    showMainContent();
                    sections.trackOrder.style.display = 'none';
                    sections.agent.style.display = 'none';
                    sections.terms.style.display = 'none';
                    
                    // Smooth scroll to top
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                } else if (href === '#track-order') {
                    // Track Order - hide main content, show track order
                    hideMainContent();
                    sections.trackOrder.style.display = 'block';
                    sections.agent.style.display = 'none';
                    sections.terms.style.display = 'none';
                    
                    // After a brief delay to ensure DOM is updated, scroll smoothly
                    setTimeout(() => {
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }, 10);
                } else if (href === '#agent') {
                    // Agent - hide main content, show agent
                    hideMainContent();
                    sections.trackOrder.style.display = 'none';
                    sections.agent.style.display = 'block';
                    sections.terms.style.display = 'none';
                    
                    // After a brief delay to ensure DOM is updated, scroll smoothly
                    setTimeout(() => {
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }, 10);
                } else if (href === '#terms') {
                    // Terms - hide main content, show terms
                    hideMainContent();
                    sections.trackOrder.style.display = 'none';
                    sections.agent.style.display = 'none';
                    sections.terms.style.display = 'block';
                    
                    // After a brief delay to ensure DOM is updated, scroll smoothly
                    setTimeout(() => {
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }, 10);
                }
            });
        });

        // Toggle mobile menu
        function toggleMobileMenu() {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            document.body.classList.toggle('menu-open');
        }

        // Close mobile menu
        function closeMobileMenu() {
            hamburger.classList.remove('active');
            navMenu.classList.remove('active');
            document.body.classList.remove('menu-open');
        }

        // Function to open Terms section (used by checkbox links)
        function openTermsSection(fromModal = null) {
            // If opening from a modal, close that modal first
            if (fromModal === 'order') {
                closeOrderModal();
            } else if (fromModal === 'agent') {
                // Close agent form if needed
                hideMainContent();
            }
            
            // Small delay to ensure modal closes first
            setTimeout(() => {
                // Update active state
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                document.querySelector('a[href="#terms"]').classList.add('active');
                
                // Close mobile menu
                closeMobileMenu();
                
                // Hide main content, show terms
                hideMainContent();
                sections.trackOrder.style.display = 'none';
                sections.agent.style.display = 'none';
                sections.terms.style.display = 'block';
                
                // Smooth scroll to top
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 300);
        }

        // Function to close Terms section
        function closeTermsSection() {
            // Go back to home
            navLinks.forEach(navLink => navLink.classList.remove('active'));
            document.querySelector('a[href="#"]').classList.add('active');
            
            showMainContent();
            sections.trackOrder.style.display = 'none';
            sections.agent.style.display = 'none';
            sections.terms.style.display = 'none';
            
            // Smooth scroll to top
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Event listeners for navigation
        hamburger.addEventListener('click', toggleMobileMenu);

        // Close menu on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && navMenu.classList.contains('active')) {
                closeMobileMenu();
            }
        });

        // Close menu on window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // Function to get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const discountParam = params.get('discount');
            return discountParam || '';
        }

        // Function to check if agent ID exists in database
        async function validateAgentId(agentId) {
            if (!agentId) return false;
            
            try {
                const response = await fetch(AGENT_DATABASE_URL);
                if (!response.ok) return false;
                
                const data = await response.json();
                if (data.success && data.data) {
                    // Skip the header row (index 0) and check each agent row
                    for (let i = 1; i < data.data.length; i++) {
                        const agent = data.data[i];
                        if (agent[0] === agentId) { // Agent ID is in first column
                            return true;
                        }
                    }
                }
                return false;
            } catch (error) {
                console.error('Error validating agent ID:', error);
                return false;
            }
        }

        // MODIFIED: Function to apply discount code with loading popup
        async function applyDiscountCode(agentId) {
            if (!agentId || discountCodeApplied) return false;
            
            showLoading('Validating Discount Code');
            
            // Small delay to ensure popup shows
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const isValid = await validateAgentId(agentId);
            
            hideLoading();
            
            if (isValid) {
                currentDiscountCode = agentId;
                currentAgentId = agentId;
                discountCodeApplied = true;
                return true;
            } else {
                alert('Invalid Discount Code');
                return false;
            }
        }

        // Loading popup functions
        function showLoading(message = 'Validating Discount Code') {
            const popup = document.getElementById('loading-popup');
            const title = popup.querySelector('h4');
            title.textContent = message;
            popup.style.display = 'flex';
        }

        function hideLoading() {
            const popup = document.getElementById('loading-popup');
            popup.style.display = 'none';
        }

        // MODIFIED: Function to auto-fill discount code from URL with loading popup
        async function checkUrlForDiscountCode() {
            const agentIdFromUrl = getUrlParams();
            
            if (agentIdFromUrl) {
                showLoading('Checking Agent Code from URL');
                
                // Small delay to ensure popup shows
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const isValid = await validateAgentId(agentIdFromUrl);
                
                hideLoading();
                
                if (isValid) {
                    // Auto-fill and disable the discount code field
                    const discountInput = document.getElementById('discount-code');
                    if (discountInput) {
                        discountInput.value = agentIdFromUrl;
                        discountInput.disabled = true;
                        discountInput.style.backgroundColor = '#f0f0f0';
                        discountInput.style.cursor = 'not-allowed';
                        
                        // Hide the apply button
                        const applyBtn = document.getElementById('apply-discount-btn');
                        if (applyBtn) {
                            applyBtn.style.display = 'none';
                        }
                        
                        // Apply the discount
                        currentDiscountCode = agentIdFromUrl;
                        currentAgentId = agentIdFromUrl;
                        discountCodeApplied = true;
                        
                        // Update order summary
                        if (currentOrderProduct) {
                            updateOrderSummary();
                        }
                        
                        // Show success message
                        alert('Agent discount code applied successfully! RM5 discount added.');
                    }
                } else {
                    // Invalid discount code from URL
                    console.warn('Invalid discount code in URL:', agentIdFromUrl);
                }
            }
        }

        // Function to add discount code line to order summary
        function addDiscountCodeToSummary() {
            // Remove existing discount code line if it exists
            let existingDiscountCodeLine = document.getElementById('order-discount-code');
            if (existingDiscountCodeLine) {
                existingDiscountCodeLine.remove();
            }
            
            // Only add if discount code is applied
            if (discountCodeApplied && currentDiscountCode) {
                const orderDetails = document.querySelector('.order-details');
                const totalItem = orderDetails.querySelector('.total-price');
                
                const discountCodeLine = document.createElement('div');
                discountCodeLine.className = 'order-item';
                discountCodeLine.id = 'order-discount-code';
                
                discountCodeLine.innerHTML = `
                    <span class="order-label">Discount Code:</span>
                    <span class="order-value" style="color: var(--secondary);">-RM ${DISCOUNT_AMOUNT.toFixed(2)}</span>
                `;
                
                // Insert before total price (or before spin discount if it exists)
                const spinDiscount = document.getElementById('order-discount');
                if (spinDiscount) {
                    orderDetails.insertBefore(discountCodeLine, spinDiscount);
                } else {
                    orderDetails.insertBefore(discountCodeLine, totalItem);
                }
            }
        }

        // Add CSS for body when menu is open
        const style = document.createElement('style');
        style.textContent = `
            body.menu-open {
                overflow: hidden;
            }
        `;
        document.head.appendChild(style);

        // Function to calculate individual category points
        function calculateCategoryPoints(product) {
            const points = {
                size: 0,
                shot: 0,
                duration: 0,
                style: 0,
                total: 0
            };
            
            // 1. Size points (0-100 points)
            const sizeRange = maxSize - minSize;
            if (sizeRange > 0) {
                const sizePointsPerInch = 100 / sizeRange;
                points.size = (product.inch - minSize) * sizePointsPerInch;
                points.size = Math.min(100, Math.max(0, points.size));
            }
            
            // 2. Duration points (0-100 points)
            const durationSeconds = convertDurationToSeconds(product.duration);
            const durationRange = maxDuration - minDuration;
            if (durationRange > 0) {
                const durationPointsPerSecond = 100 / durationRange;
                points.duration = (durationSeconds - minDuration) * durationPointsPerSecond;
                points.duration = Math.min(100, Math.max(0, points.duration));
            }
            
            // 3. Shot points (0-100 points)
            const shotRange = maxShot - minShot;
            if (shotRange > 0) {
                const shotPointsPerShot = 100 / shotRange;
                points.shot = (product.shot - minShot) * shotPointsPerShot;
                points.shot = Math.min(100, Math.max(0, points.shot));
            }
            
            // 4. Style points (S=70, V=100)
            if (product.style === 'S') {
                points.style = 70;
            } else if (product.style === 'V') {
                points.style = 100;
            }
            
            // Calculate total
            points.total = points.size + points.duration + points.shot + points.style;
            points.total = Math.min(400, points.total);
            
            return points;
        }

        // Function to open stats modal
        function openStatsModal(product) {
            // Calculate star rating and individual points
            const starRating = calculateStarRating(product);
            const categoryPoints = calculateCategoryPoints(product);
            
            // Update total points display
            document.getElementById('total-points').textContent = 
                `${Math.round(categoryPoints.total)}/400`;
            
            // Update stars display
            const starsDisplay = document.getElementById('total-stars-display');
            starsDisplay.innerHTML = generateStarHTML(starRating.stars);
            
            // Update individual category displays
            const categories = ['size', 'shot', 'duration', 'style'];
            
            categories.forEach(category => {
                const points = Math.round(categoryPoints[category]);
                const percentage = (points / 100) * 100;
                
                // Update points text
                document.getElementById(`${category}-points`).textContent = `${points} pts`;
                
                // Update bar width and value
                const bar = document.getElementById(`${category}-bar`);
                const barValue = document.getElementById(`${category}-bar-value`);
                
                // Set width with slight delay for animation
                setTimeout(() => {
                    bar.style.width = `${percentage}%`;
                    barValue.textContent = `${points} pts`;
                }, 100);
            });
            
            // Show modal
            document.getElementById('stats-modal').style.display = 'flex';
        }

        // Function to close stats modal
        function closeStatsModal() {
            document.getElementById('stats-modal').style.display = 'none';
        }

        // Initialize stats modal events
        function initializeStatsModal() {
            const statsModal = document.getElementById('stats-modal');
            const closeStatsBtn = document.getElementById('close-stats-modal');
            
            if (closeStatsBtn) {
                closeStatsBtn.addEventListener('click', closeStatsModal);
            }
            
            if (statsModal) {
                statsModal.addEventListener('click', (e) => {
                    if (e.target === statsModal) {
                        closeStatsModal();
                    }
                });
            }
            
            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && statsModal.style.display === 'flex') {
                    closeStatsModal();
                }
            });
        }

        // Function to calculate min/max values from data
        function calculateMinMaxValues(data) {
            data.forEach(item => {
                // Size
                const size = item.inch || 0;
                if (size < minSize) minSize = size;
                if (size > maxSize) maxSize = size;
                
                // Duration (in seconds)
                const durationSeconds = convertDurationToSeconds(item.duration);
                if (durationSeconds < minDuration) minDuration = durationSeconds;
                if (durationSeconds > maxDuration) maxDuration = durationSeconds;
                
                // Shot
                const shot = item.shot || 0;
                if (shot < minShot) minShot = shot;
                if (shot > maxShot) maxShot = shot;
            });
        }

        // Function to calculate star rating for a product
        function calculateStarRating(product) {
            let totalPoints = 0;
            
            // 1. Size points (0-100 points)
            const sizeRange = maxSize - minSize;
            if (sizeRange > 0) {
                const sizePointsPerInch = 100 / sizeRange;
                const sizePoints = (product.inch - minSize) * sizePointsPerInch;
                totalPoints += Math.min(100, Math.max(0, sizePoints));
            }
            
            // 2. Duration points (0-100 points)
            const durationSeconds = convertDurationToSeconds(product.duration);
            const durationRange = maxDuration - minDuration;
            if (durationRange > 0) {
                const durationPointsPerSecond = 100 / durationRange;
                const durationPoints = (durationSeconds - minDuration) * durationPointsPerSecond;
                totalPoints += Math.min(100, Math.max(0, durationPoints));
            }
            
            // 3. Shot points (0-100 points)
            const shotRange = maxShot - minShot;
            if (shotRange > 0) {
                const shotPointsPerShot = 100 / shotRange;
                const shotPoints = (product.shot - minShot) * shotPointsPerShot;
                totalPoints += Math.min(100, Math.max(0, shotPoints));
            }
            
            // 4. Style points (S=70, V=100)
            if (product.style === 'S') {
                totalPoints += 70;
            } else if (product.style === 'V') {
                totalPoints += 100;
            }
            
            // Calculate stars (4 stars = 400 points)
            const starPercentage = (totalPoints / 400) * 100;
            const stars = Math.round((starPercentage / 100) * 4 * 2) / 2;
            
            return {
                totalPoints: Math.min(400, totalPoints),
                stars: Math.min(4, Math.max(0, stars)),
                score: Math.min(4, stars)
            };
        }

        function generateStarHTML(rating) {
            let fireHTML = '';
            const fullFires = Math.floor(rating);
            const halfFire = rating % 1 >= 0.5;
            const emptyFires = 4 - fullFires - (halfFire ? 1 : 0);
            
            // Full fire icons
            for (let i = 0; i < fullFires; i++) {
                fireHTML += '<i class="fas fa-fire fire-icon"></i>';
            }
            
            // Half fire icon
            if (halfFire) {
                fireHTML += '<i class="fas fa-fire fire-icon" style="opacity: 0.7"></i>';
            }
            
            // Empty fire icons
            for (let i = 0; i < emptyFires; i++) {
                fireHTML += '<i class="fas fa-fire fire-icon empty"></i>';
            }
            
            return fireHTML;
        }

        // Add this function to calculate Minimum Order Quantity
        function calculateMOQ(price) {
            if (price < 100) return 3;
            if (price < 200) return 2;
            return 1;
        }

        // SPIN WHEEL FUNCTIONALITY
        const wheelContainer = document.getElementById('wheel-container');
        const wheelElement = document.getElementById('wheel');
        const spinBtn = document.getElementById('spin-btn');
        const wheelResult = document.getElementById('wheel-result');
        const wheelCloseBtn = document.getElementById('wheel-close');
        const SPIN_WHEEL_PRIZE_KEY = 'spinWheelPrize';

        // Wheel prizes
        const wheelPrizes = [
            { name: 'RM15<-----', value: 15 },
            { name: 'RM12<-----', value: 12 },
            { name: 'RM10<-----', value: 10 },
            { name: 'RM8<-----', value: 8 },
            { name: 'RM7<-----', value: 7 },
            { name: 'RM5<-----', value: 5 }
        ];

        // Colors for wheel sections
        const wheelColors = [
            '#A52A2A', '#fb923c', '#f59e0b', 
            '#10b981', '#3b82f6', '#8b5cf6'
        ];

        // Initialize wheel
        function initializeWheel() {
            wheelElement.innerHTML = '';
            const anglePerSection = 360 / wheelPrizes.length;
            
            wheelPrizes.forEach((prize, index) => {
                const section = document.createElement('div');
                section.className = 'wheel-section';
                section.style.backgroundColor = wheelColors[index];
                section.style.transform = `rotate(${index * anglePerSection}deg)`;
                
                const text = document.createElement('div');
                text.textContent = prize.name;
                text.style.transform = `rotate(${anglePerSection / 2}deg) translate(30px)`;
                text.style.textAlign = 'center';
                text.style.fontSize = '14px';
                text.style.width = '100px';
                
                section.appendChild(text);
                wheelElement.appendChild(section);
            });
        }

        // Check if user can spin wheel
        function canSpinWheel() {
            const lastSpin = localStorage.getItem('lastSpinDate');
            const savedPrize = localStorage.getItem(SPIN_WHEEL_PRIZE_KEY);
            
            // If user has a saved prize, they can't spin again
            if (savedPrize) {
                return false;
            }
            
            // If no last spin date, they can spin
            if (!lastSpin) {
                return true;
            }
            
            // Check if 24 hours have passed since last spin
            const lastSpinDate = new Date(lastSpin);
            const now = new Date();
            const diffHours = (now - lastSpinDate) / (1000 * 60 * 60);
            
            return diffHours >= 24;
        }

        // Show spin wheel if eligible
        function checkAndShowSpinWheel(productPrice) {
            if (productPrice >= 500 && canSpinWheel()) {
                setTimeout(() => {
                    openWheelModal();
                }, 500);
            }
        }

        // Open wheel modal
        function openWheelModal() {
            wheelResult.textContent = '';
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<i class="fas fa-redo"></i> Spin The Wheel!';
            wheelContainer.style.display = 'flex';

            setTimeout(() => {
                wheelContainer.scrollTop = 0;
            }, 100);

            initializeWheel();
        }

        // Close wheel modal
        function closeWheelModal() {
            wheelContainer.style.display = 'none';
        }

        // Spin the wheel
        function spinWheel() {
            spinBtn.disabled = true;
            spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Spinning...';
            wheelResult.textContent = '';
            
            // Random rotation
            const rotations = 5;
            const randomPrizeIndex = Math.floor(Math.random() * wheelPrizes.length);
            const anglePerSection = 360 / wheelPrizes.length;
            
            const targetAngle = 360 * rotations + (360 - (randomPrizeIndex * anglePerSection + anglePerSection / 2));
            
            // Apply rotation
            wheelElement.style.transform = `rotate(${targetAngle}deg)`;
            
            // Wait for animation to complete
            setTimeout(() => {
                const prize = wheelPrizes[randomPrizeIndex];
                wheelResult.textContent = `üéâ Congratulations! You won: RM${prize.value}`;
                
                // Save prize to localStorage
                localStorage.setItem(SPIN_WHEEL_PRIZE_KEY, prize.value.toString());
                localStorage.setItem('lastSpinDate', new Date().toISOString());
                
                spinBtn.innerHTML = '<i class="fas fa-check"></i> Prize Saved!';
                
                // Update order summary if order modal is open
                updateOrderSummary();
                
            }, 4000);
        }

        // Get current discount from localStorage
        function getCurrentDiscount() {
            const savedPrize = localStorage.getItem(SPIN_WHEEL_PRIZE_KEY);
            return savedPrize ? parseInt(savedPrize) : 0;
        }

        // Clear spin wheel prize (call this after order submission)
        function clearSpinWheelPrize() {
            localStorage.removeItem(SPIN_WHEEL_PRIZE_KEY);
            localStorage.removeItem('lastSpinDate');
        }

        // Fireworks animation for splash screen
        function createFireworksAnimation() {
            const splashScreen = document.getElementById('splash-screen');
            const colors = ['#f97316', '#fb923c', '#f59e0b', '#10b981', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'];
            
            // Create initial burst of fireworks
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    createFirework(i);
                }, i * 400);
            }
            
            function createFirework(index) {
                // Create main firework that shoots up
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                firework.style.left = `${10 + (Math.random() * 80)}%`;
                firework.style.setProperty('--top', `-${Math.random() * 150 + 50}px`);
                
                const size = 8 + Math.random() * 12;
                firework.style.width = `${size}px`;
                firework.style.height = `${size}px`;
                
                splashScreen.appendChild(firework);
                
                const speed = 800 + Math.random() * 700;
                firework.animate([
                    { transform: 'translateY(100vh) scale(0.3)', opacity: 0 },
                    { transform: 'translateY(calc(var(--top) * 1)) scale(1)', opacity: 1 }
                ], {
                    duration: speed,
                    easing: 'cubic-bezier(0.22, 0.61, 0.36, 1)'
                });
                
                // Explode after reaching top
                setTimeout(() => {
                    explodeFirework(firework);
                }, speed);
            }
            
            function explodeFirework(firework) {
                const color = firework.style.backgroundColor;
                const rect = firework.getBoundingClientRect();
                const particles = 20 + Math.floor(Math.random() * 12);
                
                // Remove the main firework
                firework.remove();
                
                // Create explosion particles
                for (let i = 0; i < particles; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'firework-particle';
                    particle.style.backgroundColor = color;
                    particle.style.left = `${rect.left}px`;
                    particle.style.top = `${rect.top}px`;
                    
                    const particleSize = 5 + Math.random() * 8;
                    particle.style.width = `${particleSize}px`;
                    particle.style.height = `${particleSize}px`;
                    
                    const angle = (Math.PI * 2 * i) / particles;
                    const distance = 80 + Math.random() * 200;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    
                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);
                    
                    splashScreen.appendChild(particle);
                    
                    const explosionDuration = 800 + Math.random() * 800;
                    
                    particle.animate([
                        { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                        { transform: 'translate(var(--tx), var(--ty)) scale(0)', opacity: 0 }
                    ], {
                        duration: explosionDuration,
                        easing: 'cubic-bezier(0.22, 0.61, 0.36, 1)',
                        fill: 'forwards'
                    });
                    
                    // Remove particle after animation
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, explosionDuration);
                }
            }
            
            // Continue fireworks until splash screen is hidden
            const continueFireworks = setInterval(() => {
                if (splashScreen.classList.contains('fade-out')) {
                    clearInterval(continueFireworks);
                    return;
                }
                // Create multiple fireworks at once
                for (let i = 0; i < 2 + Math.floor(Math.random() * 3); i++) {
                    setTimeout(() => {
                        createFirework(Math.random());
                    }, i * 200);
                }
            }, 800);
        }

        // Detect if mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // If mobile, add specific optimizations
        if (isMobile) {
            console.log('Mobile device detected, applying optimizations...');
            
            const meta = document.createElement('meta');
            meta.name = 'viewport';
            meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            document.head.appendChild(meta);
        }

        // Add this function
        function logMobileInfo() {
            console.log('Browser Info:', navigator.userAgent);
            console.log('Platform:', navigator.platform);
            console.log('Online status:', navigator.onLine);
            console.log('Screen size:', window.innerWidth, 'x', window.innerHeight);
        }

        let retryCount = 0;
        const MAX_RETRIES = 3;

        function loadDataWithRetry() {
            // Check network first
            if (!checkNetworkStatus()) {
                return;
            }
            
            // Show loading state
            catalogContainer.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <h3>Loading Fireworks Data...</h3>
                    <p>${retryCount > 0 ? `Retry attempt ${retryCount}/${MAX_RETRIES}...` : 'Fetching data from server...'}</p>
                </div>
            `;
            
            // Fetch data from Google Sheets using JSONP
            fetchDataFromGoogleSheets(handleDataWithRetry);
        }

        function handleDataWithRetry(response) {
            if (response && response.success) {
                handleData(response);
            } else {
                retryCount++;
                if (retryCount <= MAX_RETRIES) {
                    // Wait 2 seconds then retry
                    setTimeout(loadDataWithRetry, 2000);
                } else {
                    showErrorWithRetry(response?.message || 'Failed to load data. Please try again later.');
                }
            }
        }

        function showErrorWithRetry(message) {
            // Hide splash screen
            const splashScreen = document.getElementById('splash-screen');
            if (splashScreen) {
                splashScreen.classList.add('fade-out');
            }

            // Remove splash-active class
            document.body.classList.remove('splash-active');
            
            catalogContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error Loading Data</h3>
                    <p>${message}</p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="filter-btn" onclick="initializePage()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                        <button class="filter-btn" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i> Reload Page
                        </button>
                    </div>
                </div>
            `;
        }

        // Check for Service Worker issues
        function checkServiceWorkerIssues() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    if (registrations.length > 0) {
                        console.log('Service Workers detected, they might interfere with JSONP');
                    }
                });
            }
        }

        // Fetch data from Google Apps Script using JSONP
        function fetchDataFromGoogleSheets(callback) {
            // Create a unique callback name
            const callbackName = 'callback_' + new Date().getTime();
            
            // Create script element for JSONP
            const script = document.createElement('script');
            
            // Add error handling attributes
            script.crossOrigin = 'anonymous';
            script.referrerPolicy = 'no-referrer';
            
            // Add timeout handling for mobile
            const timeoutId = setTimeout(() => {
                if (window[callbackName]) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                }
                callback({
                    success: false,
                    message: 'Request timeout on mobile device'
                });
            }, 15000);
            
            script.src = `${PRODUCT_DATABASE_URL}?format=jsonp&callback=${callbackName}&t=${new Date().getTime()}&mobile=${isMobile ? 'yes' : 'no'}&v=1.0`;
            
            // Define the callback function
            window[callbackName] = function(response) {
                // Clean up
                clearTimeout(timeoutId);
                document.head.removeChild(script);
                delete window[callbackName];
                
                callback(response);
            };
            
            // Handle JSONP errors
            script.onerror = function() {
                clearTimeout(timeoutId);
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                }
                delete window[callbackName];
                
                callback({
                    success: false,
                    message: 'Network error on mobile device. Please check connection.'
                });
            };
            
            // Add script to page
            document.head.appendChild(script);
        }

        // Check network connectivity
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                showError('No internet connection. Please check your network and try again.');
                return false;
            }
            return true;
        }

        // Calculate stats
        function calculateStats(data) {
            if (!data || data.length === 0) {
                totalCountElement.textContent = '0';
                avgShotElement.textContent = '0';
                avgDurationElement.textContent = '00:00';
                filteredCountElement.textContent = '0';
                return;
            }
            
            const total = fireworksData.length;
            
            // Calculate average shots
            const totalShots = fireworksData.reduce((sum, item) => sum + (item.shot || 0), 0);
            const avgShots = Math.round(totalShots / total);
            
            // Calculate average duration in seconds
            const totalSeconds = fireworksData.reduce((sum, item) => {
                return sum + convertDurationToSeconds(item.duration || '0');
            }, 0);
            
            const avgSeconds = Math.round(totalSeconds / total);
            const avgMinutes = Math.floor(avgSeconds / 60);
            const avgRemainingSeconds = avgSeconds % 60;
            const avgDuration = avgMinutes > 0 
                ? `${avgMinutes}:${avgRemainingSeconds.toString().padStart(2, '0')}`
                : avgSeconds.toString();
            
            // Update stats
            totalCountElement.textContent = total;
            avgShotElement.textContent = avgShots;
            avgDurationElement.textContent = avgDuration;
            filteredCountElement.textContent = data.length;
        }

        // Convert duration string to seconds
        function convertDurationToSeconds(duration) {
            if (!duration) return 0;
            
            // Handle ISO date strings
            if (typeof duration === 'string' && duration.includes('T') && duration.includes('Z')) {
                try {
                    const date = new Date(duration);
                    const minutes = date.getUTCMinutes();
                    const seconds = date.getUTCSeconds();
                    return (minutes * 60) + seconds;
                } catch (e) {
                    console.error('Error parsing duration:', e);
                    return 0;
                }
            }
            
            // Check if duration is already in seconds
            if (!isNaN(duration) && duration.toString().indexOf(':') === -1) {
                return parseInt(duration);
            }
            
            // Handle MM:SS or HH:MM:SS format
            if (duration.includes(":")) {
                const parts = duration.split(":");
                if (parts.length === 2) {
                    const [min, sec] = parts.map(Number);
                    return (min * 60) + sec;
                } else if (parts.length === 3) {
                    const [hour, min, sec] = parts.map(Number);
                    const totalMinutes = (hour * 60) + min;
                    return (totalMinutes * 60) + sec;
                }
            }
            
            // Try to parse as number
            const num = parseInt(duration);
            return isNaN(num) ? 0 : num;
        }

        // Format duration for display
        function formatDuration(duration) {
            if (!duration) return "0s";
            
            // If it's an ISO date string
            if (typeof duration === 'string' && duration.includes('T') && duration.includes('Z')) {
                try {
                    const date = new Date(duration);
                    const minutes = date.getUTCMinutes();
                    const seconds = date.getUTCSeconds();
                    
                    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                } catch (e) {
                    return "0s";
                }
            }
            
            // If it's just a number, assume seconds
            if (!isNaN(duration) && duration.toString().indexOf(':') === -1) {
                const seconds = parseInt(duration);
                if (seconds < 60) {
                    return `${seconds}s`;
                } else {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }
            }
            
            // If it's already in MM:SS or HH:MM:SS format
            if (duration.includes(":")) {
                const parts = duration.split(":");
                if (parts.length === 2) {
                    const [min, sec] = parts;
                    return `${min}:${sec.padStart(2, '0')}`;
                } else if (parts.length === 3) {
                    const [hour, min, sec] = parts;
                    const totalMinutes = (parseInt(hour) * 60) + parseInt(min);
                    return `${totalMinutes}:${sec.padStart(2, '0')}`;
                }
            }
            
            return `${duration}s`;
        }

        // Create catalog card for a firework
        function createFireworkCard(item) {
            // Calculate star rating for this product
            const starRating = calculateStarRating(item);

            const card = document.createElement("div");
            card.className = "firework-card";
            card.dataset.shot = item.shot || 0;
            card.dataset.style = item.style || '';
            
            const durationDisplay = formatDuration(item.duration);
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-code">${item.code || 'N/A'}</div>
                    <div class="card-style style-${item.style || ''}">${item.style || 'N/A'} Style</div>
                </div>
                <div class="card-image-container">
                    <img src="${item.image || ''}" alt="${item.name || 'Firework'}" class="card-image" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <div class="shot-badge">${item.shot || 0} Shots</div>
                    <!-- STAR RATING ADDED HERE -->
                    <div class="star-rating" data-product='${JSON.stringify(item)}'>
                        <div class="stars">
                            ${generateStarHTML(starRating.stars)}
                        </div>
                        <div class="rating-score">${starRating.score.toFixed(1)}</div>
                    </div>
                    ${item.video ? `
                    <div class="video-overlay" data-video="${item.video}" data-name="${item.name}">
                        <button class="video-btn">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    ` : ''}
                </div>
                <div class="card-content">
                    <h3 class="card-name">${item.name || 'Unnamed Firework'}</h3>
                    <div class="card-details">
                        <div class="detail-item">
                            <span class="detail-label">Size</span>
                            <span class="detail-value">${item.inch || 0}"</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Duration</span>
                            <span class="detail-value duration-value">${durationDisplay}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Shot Count</span>
                            <span class="detail-value">${item.shot || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Style</span>
                            <span class="detail-value">${item.style || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="price-section">
                        <div class="price-label">Price (RM)</div>
                        <div class="price-value">${item.price || 0}</div>
                        <button class="buy-btn" data-product='${JSON.stringify(item)}'>
                            <i class="fas fa-shopping-cart"></i> Buy Now
                        </button>
                    </div>
                </div>
            `;
            
            // Add click event to video button if video exists
            const videoBtn = card.querySelector('.video-overlay');
            if (videoBtn) {
                videoBtn.addEventListener('click', () => {
                    openVideoModal(item.video, `${item.code || ''} - ${item.name || ''}`);
                });
            }
            
            // Add click event to buy button
            const buyBtn = card.querySelector('.buy-btn');
            if (buyBtn) {
                buyBtn.addEventListener('click', () => {
                    const productData = JSON.parse(buyBtn.getAttribute('data-product'));
                    openOrderModal(productData);
                });
            }
            
            return card;
        }

        // Filter fireworks based on selected filters
        function filterFireworks() {
            const shotValue = shotFilter.value;
            const styleValue = styleFilter.value;
            const inchValue = inchFilter.value;
            const durationValue = durationFilter.value;
            const priceValue = priceFilter.value;

            return fireworksData.filter(item => {
                // Filter by shot count
                if (shotValue !== "all") {
                    const shot = item.shot || 0;
                    
                    if (shotValue === "<49") {
                        if (shot >= 49) return false;
                    } else if (shotValue === "49-138") {
                        if (shot < 49 || shot > 138) return false;
                    } else if (shotValue === "138-168") {
                        if (shot < 138 || shot > 168) return false;
                    } else if (shotValue === "168-188") {
                        if (shot < 168 || shot > 188) return false;
                    } else if (shotValue === "188-200") {
                        if (shot < 188 || shot > 200) return false;
                    } else if (shotValue === "200>") {
                        if (shot <= 200) return false;
                    }
                }
                
                // Filter by style
                if (styleValue !== "all" && item.style !== styleValue) return false;
                
                // Filter by inch size
                if (inchValue !== "all" && item.inch !== parseInt(inchValue)) return false;
                
                // Filter by duration
                if (durationValue !== "all") {
                    const durationSeconds = convertDurationToSeconds(item.duration);
                    
                    if (durationValue === "short" && durationSeconds >= 60) return false;
                    if (durationValue === "medium" && (durationSeconds < 60 || durationSeconds > 120)) return false;
                    if (durationValue === "long" && (durationSeconds < 120 || durationSeconds > 180)) return false;
                    if (durationValue === "extra-long" && durationSeconds <= 180) return false;
                }

                // Filter by price range
                if (priceValue !== "all") {
                    const price = item.price || 0;
                    
                    switch(priceValue) {
                        case "<100":
                            if (price >= 100) return false;
                            break;
                        case "100-300":
                            if (price < 100 || price > 300) return false;
                            break;
                        case "300-500":
                            if (price < 300 || price > 500) return false;
                            break;
                        case "500-700":
                            if (price < 500 || price > 700) return false;
                            break;
                        case "700-900":
                            if (price < 700 || price > 900) return false;
                            break;
                        case "900>":
                            if (price < 900) return false;
                            break;
                    }
                }

                // Filter by star rating
                if (starFilter.value !== "all") {
                    const starRating = calculateStarRating(item);
                    const stars = starRating.stars;
                    
                    switch(starFilter.value) {
                        case "1-2":
                            if (stars < 1 || stars > 2) return false;
                            break;
                        case "2-3":
                            if (stars < 2 || stars > 3) return false;
                            break;
                        case "3-4":
                            if (stars < 3 || stars > 4) return false;
                            break;
                    }
                }
                return true;
            });
        }

        // Populate catalog with cards
        function populateCatalog(data) {
            catalogContainer.innerHTML = "";
            
            if (!data || data.length === 0) {
                catalogContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No Fireworks Found</h3>
                        <p>Try adjusting your filters to see more products.</p>
                    </div>
                `;
                return;
            }
            
            data.forEach(item => {
                const card = createFireworkCard(item);
                catalogContainer.appendChild(card);
            });
        }

        // Open video modal
        function openVideoModal(videoUrl, title) {
            if (!videoUrl) {
                alert('No video available for this product');
                return;
            }
            
            modalVideo.src = videoUrl;
            modalTitle.textContent = title;
            videoModal.style.display = "flex";
            modalVideo.play();
        }

        // Close video modal
        function closeVideoModal() {
            modalVideo.pause();
            modalVideo.src = "";
            videoModal.style.display = "none";
        }

        // MODIFIED: Update the openOrderModal function to check URL parameters
        function openOrderModal(product) {
            currentOrderProduct = product;
            
            // Calculate MOQ based on product price
            const moq = calculateMOQ(product.price);
            
            // Update order details
            orderProductName.textContent = `${product.code} - ${product.name}`;
            
            // Reset form AND set quantity to MOQ
            orderForm.reset();
            document.getElementById('product-quantity').value = moq;
            
            // Reset terms checkbox
            document.getElementById('agree-terms').checked = false;
            
            submitOrderBtn.disabled = false;
            
            // Reset discount code state for new order
            discountCodeApplied = false;
            currentDiscountCode = '';
            currentAgentId = '';
            
            // Enable discount code field and show apply button
            const discountInput = document.getElementById('discount-code');
            if (discountInput) {
                discountInput.disabled = false;
                discountInput.style.backgroundColor = '';
                discountInput.style.cursor = '';
                discountInput.value = '';
            }
            
            const applyBtn = document.getElementById('apply-discount-btn');
            if (applyBtn) {
                applyBtn.style.display = '';
            }
            
            // Check URL for discount code
            checkUrlForDiscountCode();
            
            // Calculate total price with discount
            updateOrderSummary();
            
            // Show modal
            orderModal.style.display = "flex";
            
            // Check if user can spin wheel (product price >= RM500)
            if (product.price >= 500) {
                checkAndShowSpinWheel(product.price);
            }
        }

        // Close order modal
        function closeOrderModal() {
            orderModal.style.display = "none";
            currentOrderProduct = null;
        }

        // Calculate total price
        function calculateTotalPrice() {
            if (!currentOrderProduct) return 0;
            const productPrice = currentOrderProduct.price || 0;
            return productPrice;
        }

        // MODIFIED: Update the updateOrderSummary function to include discount code
        function updateOrderSummary() {
            if (!currentOrderProduct) return;

            // Calculate MOQ
            const moq = calculateMOQ(currentOrderProduct.price);
            
            // Display MOQ
            const moqElement = document.getElementById('order-moq');
            if (moqElement) {
                moqElement.textContent = moq + ' unit(s)';
                
                // Highlight if quantity is at MOQ
                const quantity = parseInt(document.getElementById('product-quantity').value) || 1;
                if (quantity === moq) {
                    moqElement.style.color = 'var(--primary)';
                    moqElement.style.fontWeight = '700';
                } else {
                    moqElement.style.color = 'var(--dark)';
                    moqElement.style.fontWeight = '600';
                }
            }
            
            // Get quantity
            const quantityInput = document.getElementById('product-quantity');
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Calculate product price based on quantity
            const productPricePerUnit = currentOrderProduct.price || 0;
            const totalProductPrice = productPricePerUnit * quantity;

            // Calculate postage fee (postage per unit √ó quantity)
            const postagePerUnit = currentOrderProduct.postage || 0;
            const totalPostage = postagePerUnit * quantity;
            
            // Check if product is eligible for spin wheel discount (‚â• RM500)
            const isEligibleForSpinDiscount = totalProductPrice >= 500;
            
            // Only apply spin discount if product is eligible AND user has a saved prize
            const spinDiscount = isEligibleForSpinDiscount ? getCurrentDiscount() : 0;
            
            // Apply discount code discount (always RM5 if valid)
            const discountCodeDiscount = discountCodeApplied ? DISCOUNT_AMOUNT : 0;
            
            // Calculate total price with all discounts
            const totalPrice = totalProductPrice + totalPostage - spinDiscount - discountCodeDiscount;
            
            // Update order summary display
            orderProductPrice.textContent = `RM ${totalProductPrice.toFixed(2)} (${quantity} √ó RM ${productPricePerUnit.toFixed(2)})`;

            // Update postage fee display
            const postageElement = document.getElementById('order-postage-fee');
            if (postageElement) {
                postageElement.textContent = `RM ${totalPostage.toFixed(2)} (${quantity} √ó RM ${postagePerUnit.toFixed(2)})`;
            }

            orderTotalPrice.textContent = `RM ${totalPrice.toFixed(2)}`;
            
            // Update spin discount line
            let spinDiscountElement = document.getElementById('order-discount');
            
            // If product is not eligible for spin discount, remove spin discount line if it exists
            if (!isEligibleForSpinDiscount) {
                if (spinDiscountElement) {
                    spinDiscountElement.remove();
                }
            } else {
                // Only show spin discount line for eligible products
                if (!spinDiscountElement && spinDiscount > 0) {
                    spinDiscountElement = document.createElement('div');
                    spinDiscountElement.className = 'order-item';
                    spinDiscountElement.id = 'order-discount';
                    
                    const spinDiscountLabel = document.createElement('span');
                    spinDiscountLabel.className = 'order-label';
                    spinDiscountLabel.textContent = 'Spin The Wheel Discount:';
                    
                    const spinDiscountValue = document.createElement('span');
                    spinDiscountValue.className = 'order-value';
                    spinDiscountValue.id = 'order-discount-value';
                    
                    spinDiscountElement.appendChild(spinDiscountLabel);
                    spinDiscountElement.appendChild(spinDiscountValue);
                    
                    // Insert before total price
                    const orderDetails = document.querySelector('.order-details');
                    const totalItem = orderDetails.querySelector('.total-price');
                    orderDetails.insertBefore(spinDiscountElement, totalItem);
                }
                
                if (spinDiscountElement) {
                    const spinDiscountValueElement = spinDiscountElement.querySelector('#order-discount-value');
                    if (spinDiscount > 0) {
                        spinDiscountValueElement.textContent = `-RM ${spinDiscount.toFixed(2)}`;
                        spinDiscountValueElement.style.color = 'var(--secondary)';
                        spinDiscountValueElement.style.fontWeight = '700';
                    } else {
                        spinDiscountElement.remove();
                    }
                }
            }
            
            // Add discount code line to order summary
            addDiscountCodeToSummary();
        }

        // NEW FUNCTION: Generate WhatsApp message
        function generateWhatsAppMessage(orderData) {
            // Format the message exactly as you requested
            const message = `DETAIL :
${orderData.customerName}
${orderData.customerPhone}
${orderData.customerEmail}
${orderData.deliveryAddress}
${orderData.customerNote ? `Note: ${orderData.customerNote}` : ''}

PRODUCT :
${orderData.productCode} - ${orderData.productName} x ${orderData.productQuantity}

PRICE :
Product price RM${orderData.productPrice.toFixed(2)} (${orderData.productQuantity} x RM${(orderData.productPrice/orderData.productQuantity).toFixed(2)})
Postage fee RM${orderData.postageFee.toFixed(2)} (${orderData.productQuantity} X RM${orderData.postageFee/orderData.productQuantity})
${orderData.discountCode > 0 ? `Discount code -RM${orderData.discountCode.toFixed(2)}\n` : ''}${orderData.spinPrize > 0 ? `Spin the wheel -RM${orderData.spinPrize.toFixed(2)}\n` : ''}
TOTAL PRICE :
RM${orderData.totalPrice.toFixed(2)}

User Id (AgentId): ${orderData.userId || 'None'}`;

            // Encode the message for URL
            return encodeURIComponent(message);
        }

        // NEW FUNCTION: Open WhatsApp with message
        function openWhatsApp(message) {
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        // MODIFIED: Update the handleOrderSubmit function to send to database and open WhatsApp
        async function handleOrderSubmit(event) {
            event.preventDefault();
            
            if (!currentOrderProduct) {
                alert('Product information is missing. Please try again.');
                return;
            }
            
            // Check if terms checkbox is checked
            const termsCheckbox = document.getElementById('agree-terms');
            if (!termsCheckbox.checked) {
                alert('Please agree to the Terms & Conditions to proceed with your order.');
                termsCheckbox.focus();
                return;
            }
            
            // Get form data
            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const customerEmail = document.getElementById('customer-email').value;
            const deliveryAddress = document.getElementById('delivery-address').value;
            const customerNote = document.getElementById('customer-note').value;
            const productQuantity = document.getElementById('product-quantity').value;
            
            // Validate form data
            if (!customerName || !customerPhone || !customerEmail || !deliveryAddress) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Validate phone number - must start with 6 (no starting with 0)
            const cleanedPhone = customerPhone.replace(/\s+|-|\+/g, '');

            // Check if phone has symbol
            if (/[+\-()]/.test(customerPhone)) {
                alert('Phone number cannot contain symbols like +, -, (, ).\n\nPlease use only numbers (e.g., 601160801477).');
                return;
            }

            // Check if phone has spaces
            if (customerPhone.includes(' ')) {
                alert('Phone number cannot contain spaces.\n\nPlease remove spaces (e.g., 601160801477 instead of 6011 6080 1477).');
                return;
            }
            
            // Check if phone starts with 0
            if (cleanedPhone.startsWith('0')) {
                alert('Phone number should start with "6" (e.g., 60123456789), not with "0".\n\nPlease remove the leading 0 and start with 6.');
                return;
            }
            
            // Check if phone starts with 6 and has valid length
            if (!cleanedPhone.startsWith('6')) {
                alert('Phone number should start with "6" (e.g., 60123456789).\n\nPlease enter a valid Malaysian phone number starting with 6.');
                return;
            }
            
            // Check total length
            if (cleanedPhone.length < 10 || cleanedPhone.length > 15) {
                alert('Phone number should be 10-11 digits starting with "6" (e.g., 60123456789).\n\nPlease enter a valid Malaysian phone number.');
                return;
            }
            
            // Check if all characters are numbers
            if (!/^\d+$/.test(cleanedPhone)) {
                alert('Phone number should contain only numbers.\n\nPlease enter a valid Malaysian phone number (e.g., 60123456789).');
                return;
            }
            
            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(customerEmail)) {
                alert('Please enter a valid email address.');
                return;
            }

            // Calculate prices with quantity
            const quantity = parseInt(productQuantity) || 1;
            const productPricePerUnit = currentOrderProduct.price || 0;
            const totalProductPrice = productPricePerUnit * quantity;
            
            // Calculate postage fee
            const postagePerUnit = currentOrderProduct.postage || 0;
            const totalPostage = postagePerUnit * quantity;
            
            // Check if product is eligible for spin discount (total price ‚â• RM500)
            const isEligibleForSpinDiscount = totalProductPrice >= 500;
            const spinDiscount = isEligibleForSpinDiscount ? getCurrentDiscount() : 0;
            
            // Apply discount code discount (always RM5 if valid)
            const discountCodeDiscount = discountCodeApplied ? DISCOUNT_AMOUNT : 0;
            
            const totalPrice = totalProductPrice + totalPostage - spinDiscount - discountCodeDiscount;
            
            // Disable submit button while processing
            submitOrderBtn.disabled = true;
            submitOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Create order data object WITH DISCOUNT CODE AND USER ID
            const orderData = {
                timestamp: new Date().toISOString(),
                productCode: currentOrderProduct.code,
                productName: currentOrderProduct.name,
                productPrice: totalProductPrice,
                productQuantity: quantity,
                postageFee: totalPostage,
                discount: spinDiscount,
                discountCode: discountCodeApplied ? DISCOUNT_AMOUNT : 0,
                userId: currentAgentId || "",
                customerName: customerName,
                customerPhone: cleanedPhone,
                customerEmail: customerEmail,
                deliveryAddress: deliveryAddress,
                spinPrize: spinDiscount,
                customerNote: customerNote,
                totalPrice: totalPrice
            };
            
            try {
                // Show loading
                showLoading('Saving order to database...');
                
                // Send order data to Google Sheets
                const sheetResponse = await sendOrderToGoogleSheets(orderData);
                
                hideLoading();
                
                if (sheetResponse && sheetResponse.success) {
                    // Clear spin wheel prize after successful order
                    clearSpinWheelPrize();
                    
                    // Generate WhatsApp message
                    const whatsappMessage = generateWhatsAppMessage(orderData);
                    
                    // Show confirmation message
                    let message = `Order submitted successfully!\n\n`;
                    message += `Product: ${currentOrderProduct.code} - ${currentOrderProduct.name}\n`;
                    message += `Quantity: ${quantity}\n`;
                    message += `Product Price: RM ${totalProductPrice.toFixed(2)}\n`;
                    message += `Postage Fee: RM ${totalPostage.toFixed(2)}\n`;
                    if (spinDiscount > 0) {
                        message += `Spin Wheel Discount: -RM ${spinDiscount.toFixed(2)}\n`;
                    }
                    if (discountCodeDiscount > 0) {
                        message += `Agent Discount Code: -RM ${discountCodeDiscount.toFixed(2)}\n`;
                    }
                    message += `Total Amount: RM ${totalPrice.toFixed(2)}\n\n`;
                    message += `WhatsApp will now open with your order details.\n`;
                    message += `Please send the message to complete your order.`;
                    
                    alert(message);
                    
                    // Close order modal
                    closeOrderModal();
                    
                    // Open WhatsApp with the formatted message
                    openWhatsApp(whatsappMessage);
                    
                } else {
                    throw new Error('Failed to save order data. Please try again.');
                }
                
            } catch (error) {
                // Re-enable submit button
                submitOrderBtn.disabled = false;
                submitOrderBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Submit Order to WhatsApp';
                
                // Show error message
                alert(`Error: ${error.message}\n\nPlease try again or contact support.`);
                
                console.error('Order Submission Error:', error);
            }
        }

        // NEW FUNCTION: Send order data to Google Sheets
        async function sendOrderToGoogleSheets(orderData) {
            try {
                const response = await fetch(ORDER_DATABASE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                // With no-cors mode, we can't read the response
                // But we assume it's successful if no network error
                return { success: true };
                
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                throw error;
            }
        }

        // Toggle between grid and list view
        function toggleView(viewType) {
            if (viewType === 'grid') {
                catalogContainer.classList.remove('list-view');
                catalogContainer.classList.add('catalog-grid');
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
            } else {
                catalogContainer.classList.remove('catalog-grid');
                catalogContainer.classList.add('list-view');
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
                
                // Add list view styles dynamically
                const style = document.createElement('style');
                style.id = 'list-view-styles';
                style.textContent = `
                    .list-view {
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                    }
                    
                    .list-view .firework-card {
                        flex-direction: row;
                        max-height: 250px;
                    }
                    
                    .list-view .card-image-container {
                        width: 250px;
                        height: 100%;
                        flex-shrink: 0;
                    }
                    
                    .list-view .card-content {
                        flex-grow: 1;
                        display: flex;
                        flex-direction: row;
                        align-items: center;
                        gap: 30px;
                        padding-right: 30px;
                    }
                    
                    .list-view .card-name {
                        margin-bottom: 0;
                        width: 200px;
                    }
                    
                    .list-view .card-details {
                        display: flex;
                        flex-direction: row;
                        gap: 20px;
                        margin-bottom: 0;
                        flex-grow: 1;
                    }
                    
                    .list-view .detail-item {
                        width: 100px;
                        align-items: center;
                    }
                    
                    .list-view .price-section {
                        width: 150px;
                        margin-top: 0;
                    }
                    
                    @media (max-width: 1100px) {
                        .list-view .firework-card {
                            flex-direction: column;
                            max-height: none;
                        }
                        
                        .list-view .card-image-container {
                            width: 100%;
                            height: 200px;
                        }
                        
                        .list-view .card-content {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 15px;
                            padding-right: 22px;
                        }
                        
                        .list-view .card-name {
                            width: 100%;
                        }
                        
                        .list-view .card-details {
                            width: 100%;
                        }
                        
                        .list-view .price-section {
                            width: 100%;
                        }
                    }
                `;
                
                // Remove old styles if they exist
                const oldStyles = document.getElementById('list-view-styles');
                if (oldStyles) oldStyles.remove();
                
                document.head.appendChild(style);
            }
        }

        // Handle data from JSONP response
        function handleData(response) {
            if (response && response.success) {
                // Transform the data to match your original format
                fireworksData = response.data.map(item => {
                    return {
                        code: item.Code || '',
                        name: item.Name || '',
                        shot: parseInt(item.Shot) || 0,
                        style: item.Style || '',
                        inch: parseInt(item.Inch) || 0,
                        duration: item.Duration || '0',
                        price: parseFloat(item.Price) || 0,
                        image: item.Image || '',
                        video: item.Video || '',
                        postage: parseFloat(item.Postage) || 0
                    };
                });
                
                // Remove any invalid items
                fireworksData = fireworksData.filter(item => item.code && item.name);

                // Calculate min/max values for star rating
                calculateMinMaxValues(fireworksData);
                
                // Calculate and display initial stats
                calculateStats(fireworksData);
                
                // Populate catalog with all fireworks
                populateCatalog(fireworksData);
                filteredData = fireworksData;
                
                // Hide splash screen after data loads
                setTimeout(() => {
                    const splashScreen = document.getElementById('splash-screen');
                    if (splashScreen) {
                        splashScreen.classList.add('fade-out');
                    }
                    // Remove splash-active class
                    document.body.classList.remove('splash-active');
                }, 500);
                
            } else {
                showError(response?.message || 'Failed to load data from server');
                
                // Still hide splash screen on error
                setTimeout(() => {
                    const splashScreen = document.getElementById('splash-screen');
                    if (splashScreen) {
                        splashScreen.classList.add('fade-out');
                    }
                    // Remove splash-active class
                    document.body.classList.remove('splash-active');
                }, 1000);
            }
        }

        // Show error message
        function showError(message) {
            // Hide splash screen first
            const splashScreen = document.getElementById('splash-screen');
            if (splashScreen) {
                splashScreen.classList.add('fade-out');
            }

            // Remove splash-active class
            document.body.classList.remove('splash-active');
            
            // Show error in catalog
            catalogContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error Loading Data</h3>
                    <p>${message}</p>
                    <button class="filter-btn" onclick="initializePage()" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            `;
        }

        // Update initializePage function to handle splash screen
        function initializePage() {
            // Check network first
            if (!checkNetworkStatus()) {
                return;
            }

            // Add splash-active class to body
            document.body.classList.add('splash-active');
            
            // Start fireworks animation
            createFireworksAnimation();
            
            // Show loading state in catalog container
            catalogContainer.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <h3>Loading Fireworks Data...</h3>
                    <p>Fetching data from server...</p>
                </div>
            `;
            
            // Fetch data from Google Sheets using JSONP
            fetchDataFromGoogleSheets(handleData);
        }

        // Start the page when DOM is loaded
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize sections
            initializeSections();

            // Check for URL discount code when page loads
            setTimeout(() => {
                checkUrlForDiscountCode();
            }, 1000);

            // Initialize agent form
            initializeAgentForm();

            // Initialize stats modal
            initializeStatsModal();

            // Add discount code event listener
            const applyDiscountBtn = document.getElementById('apply-discount-btn');
            const discountInput = document.getElementById('discount-code');
            
            if (applyDiscountBtn) {
                applyDiscountBtn.addEventListener('click', async () => {
                    const agentId = discountInput.value.trim();
                    if (!agentId) {
                        alert('Please enter a discount code');
                        return;
                    }
                    
                    const isValid = await applyDiscountCode(agentId);
                    if (isValid) {
                        // Disable the field after successful application
                        discountInput.disabled = true;
                        discountInput.style.backgroundColor = '#f0f0f0';
                        discountInput.style.cursor = 'not-allowed';
                        applyDiscountBtn.style.display = 'none';
                        
                        // Update order summary
                        updateOrderSummary();
                        
                        // Show success message
                        alert('Discount code applied successfully! RM5 discount added.');
                    }
                });
            }
            
            // Allow pressing Enter in discount code field
            if (discountInput) {
                discountInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const agentId = discountInput.value.trim();
                        if (!agentId) {
                            alert('Please enter a discount code');
                            return;
                        }
                        
                        const isValid = await applyDiscountCode(agentId);
                        if (isValid) {
                            // Disable the field after successful application
                            discountInput.disabled = true;
                            discountInput.style.backgroundColor = '#f0f0f0';
                            discountInput.style.cursor = 'not-allowed';
                            
                            const applyBtn = document.getElementById('apply-discount-btn');
                            if (applyBtn) {
                                applyBtn.style.display = 'none';
                            }
                            
                            // Update order summary
                            updateOrderSummary();
                            
                            // Show success message
                            alert('Discount code applied successfully! RM5 discount added.');
                        }
                    }
                });
            }

            // Add this with other modal event listeners
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    if (videoModal.style.display === "flex") {
                        closeVideoModal();
                    }
                    if (orderModal.style.display === "flex") {
                        closeOrderModal();
                    }
                    if (wheelContainer.style.display === 'flex') {
                        closeWheelModal();
                    }
                    if (document.getElementById('stats-modal').style.display === 'flex') {
                        closeStatsModal();
                    }
                    if (document.getElementById('terms').style.display === 'block') {
                        closeTermsSection();
                    }
                }
            });

            // Update the increase/decrease button event listeners:
            document.getElementById('increase-qty').addEventListener('click', () => {
                const quantityInput = document.getElementById('product-quantity');
                let quantity = parseInt(quantityInput.value) || 1;
                if (quantity < 10) {
                    quantityInput.value = quantity + 1;
                    updateOrderSummary();
                }
            });

            document.getElementById('decrease-qty').addEventListener('click', () => {
                if (!currentOrderProduct) return;
                
                const quantityInput = document.getElementById('product-quantity');
                let quantity = parseInt(quantityInput.value) || 1;
                
                // Calculate MOQ for this product
                const moq = calculateMOQ(currentOrderProduct.price);
                
                // Only decrease if above MOQ
                if (quantity > moq) {
                    quantityInput.value = quantity - 1;
                    updateOrderSummary();
                } else {
                    // Show message that user cannot go below MOQ
                    alert(`Minimum Order Quantity (MOQ) for this product is ${moq}. You cannot order less than this.`);
                }
            });

            // Update the quantity input change event:
            document.getElementById('product-quantity').addEventListener('change', () => {
                if (!currentOrderProduct) return;
                
                const quantityInput = document.getElementById('product-quantity');
                let quantity = parseInt(quantityInput.value) || 1;
                const moq = calculateMOQ(currentOrderProduct.price);
                
                // Ensure quantity is at least MOQ
                if (quantity < moq) {
                    alert(`Minimum Order Quantity (MOQ) for this product is ${moq}. Setting quantity to ${moq}.`);
                    quantity = moq;
                }
                
                // Ensure quantity is within maximum limit
                if (quantity > 10) quantity = 10;
                
                quantityInput.value = quantity;
                updateOrderSummary();
            });

            // Also update when quantity input is typed into
            document.getElementById('product-quantity').addEventListener('input', updateOrderSummary);

            logMobileInfo();
            checkServiceWorkerIssues();
            
            // Set up filter button events
            applyFiltersBtn.addEventListener("click", () => {
                const filteredData = filterFireworks();
                populateCatalog(filteredData);
                filteredCountElement.textContent = filteredData.length;
            });
            
            resetFiltersBtn.addEventListener("click", () => {
                shotFilter.value = "all";
                styleFilter.value = "all";
                inchFilter.value = "all";
                durationFilter.value = "all";
                priceFilter.value = "all"; 
                document.getElementById('star-filter').value = "all";
                
                populateCatalog(fireworksData);
                filteredCountElement.textContent = fireworksData.length;
            });
            
            // Set up modal events
            closeModalBtn.addEventListener("click", closeVideoModal);
            videoModal.addEventListener("click", (e) => {
                if (e.target === videoModal) {
                    closeVideoModal();
                }
            });
            
            // Set up order modal events
            closeOrderModalBtn.addEventListener("click", closeOrderModal);
            cancelOrderBtn.addEventListener("click", closeOrderModal);
            orderModal.addEventListener("click", (e) => {
                if (e.target === orderModal) {
                    closeOrderModal();
                }
            });
            
            // Set up order form submission
            orderForm.addEventListener("submit", handleOrderSubmit);
            
            // Set up view toggle events
            gridViewBtn.addEventListener("click", () => toggleView('grid'));
            listViewBtn.addEventListener("click", () => toggleView('list'));
            
            // Close modal on escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    if (videoModal.style.display === "flex") {
                        closeVideoModal();
                    }
                    if (orderModal.style.display === "flex") {
                        closeOrderModal();
                    }
                }
            });
            
            // Add a timeout to hide splash screen if data takes too long
            setTimeout(() => {
                const splashScreen = document.getElementById('splash-screen');
                if (splashScreen && !splashScreen.classList.contains('fade-out')) {
                    splashScreen.classList.add('fade-out');
                    console.log('Safety timeout: Hiding splash screen after delay');
                }
            }, 15000);
            
            // Initialize the page
            initializePage();
        });

        // Add event listeners for wheel functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize wheel on page load
            initializeWheel();
            
            // Wheel event listeners
            spinBtn.addEventListener('click', spinWheel);
            wheelCloseBtn.addEventListener('click', closeWheelModal);
            wheelContainer.addEventListener('click', (e) => {
                if (e.target === wheelContainer) {
                    closeWheelModal();
                }
            });
            
            // Close wheel on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && wheelContainer.style.display === 'flex') {
                    closeWheelModal();
                }
            });
            
            // Check for existing prize on page load and update UI
            setTimeout(() => {
                if (getCurrentDiscount() > 0) {
                    console.log('User has existing discount:', getCurrentDiscount());
                }
            }, 1000);
            
            // Check and clear expired prizes (older than 24 hours)
            const lastSpin = localStorage.getItem('lastSpinDate');
            if (lastSpin) {
                const lastSpinDate = new Date(lastSpin);
                const now = new Date();
                const diffHours = (now - lastSpinDate) / (1000 * 60 * 60);
                
                if (diffHours >= 24) {
                    clearSpinWheelPrize();
                }
            }
        });

        // Add event delegation for star rating clicks
        document.addEventListener('click', (e) => {
            // Check if clicked element is within a star-rating div
            const starRatingElement = e.target.closest('.star-rating');
            
            if (starRatingElement) {
                e.stopPropagation();
                
                // Get product data from data attribute
                const productData = JSON.parse(starRatingElement.getAttribute('data-product'));
                
                // Open stats modal with product data
                openStatsModal(productData);
            }
        });

        // Generate Agent ID based on the rules
        function generateAgentId(name, phone, email) {
            // 1. Get last 4 characters of the name (from the back)
            const namePart = name.replace(/\s+/g, '').slice(-4).toLowerCase();
            
            // 2. Get last 4 numbers of the phone (from the back)
            const phonePart = phone.replace(/\D/g, '').slice(-4);
            
            // 3. Get first 4 characters of the email (from the front, before @)
            const emailUser = email.split('@')[0];
            const emailPart = emailUser.slice(0, 4).toLowerCase();
            
            // Combine all parts
            return namePart + phonePart + emailPart;
        }

        // Preview Agent ID as user types
        function setupAgentFormPreview() {
            const nameInput = document.getElementById('agent-name');
            const phoneInput = document.getElementById('agent-phone');
            const emailInput = document.getElementById('agent-email');
            const previewDiv = document.getElementById('agent-id-preview');
            const previewId = document.getElementById('preview-agent-id');
            
            function updatePreview() {
                const name = nameInput.value.trim();
                const phone = phoneInput.value.trim();
                const email = emailInput.value.trim();
                
                if (name && phone && email) {
                    // Clean phone for preview
                    const cleanedPhone = phone.replace(/\s+|-|\+/g, '');
                    const agentId = generateAgentId(name, cleanedPhone, email);
                    previewId.textContent = agentId;
                    previewDiv.style.display = 'block';
                } else {
                    previewDiv.style.display = 'none';
                }
            }
            
            nameInput.addEventListener('input', updatePreview);
            phoneInput.addEventListener('input', updatePreview);
            emailInput.addEventListener('input', updatePreview);
        }

        // MODIFIED: Handle agent form submission with terms checkbox
        async function handleAgentSubmit(event) {
            event.preventDefault();
            
            // Check if terms checkbox is checked
            const agentTermsCheckbox = document.getElementById('agent-agree-terms');
            if (!agentTermsCheckbox.checked) {
                alert('Please agree to the Terms & Conditions to submit your agent application.');
                agentTermsCheckbox.focus();
                return;
            }
            
            // Get form data
            const name = document.getElementById('agent-name').value.trim();
            const phone = document.getElementById('agent-phone').value.trim();
            const email = document.getElementById('agent-email').value.trim();
            const address = document.getElementById('agent-address').value.trim();
            
            // Validate required fields
            if (!name || !phone || !email || !address) {
                showAgentMessage('Please fill in all required fields.', 'error');
                return;
            }
            
            // Phone validation
            const cleanedPhone = phone.replace(/\s+|-|\+/g, '');

            if (/[+\-()]/.test(phone)) {
                showAgentMessage('Phone number cannot contain symbols like +, -, (, ).\n\nPlease use only numbers (e.g., 601160801477).', 'error');
                return;
            }

            if (phone.includes(' ')) {
                showAgentMessage('Phone number cannot contain spaces.\n\nPlease remove spaces (e.g., 601160801477 instead of 6011 6080 1477).', 'error');
                return;
            }
            
            if (cleanedPhone.startsWith('0')) {
                showAgentMessage('Phone number should start with "6" (e.g., 60123456789), not with "0".\n\nPlease remove the leading 0 and start with 6.', 'error');
                return;
            }
            
            if (!cleanedPhone.startsWith('6')) {
                showAgentMessage('Phone number should start with "6" (e.g., 60123456789).\n\nPlease enter a valid Malaysian phone number starting with 6.', 'error');
                return;
            }
            
            if (cleanedPhone.length < 10 || cleanedPhone.length > 15) {
                showAgentMessage('Phone number should be 10-11 digits starting with "6" (e.g., 60123456789).\n\nPlease enter a valid Malaysian phone number.', 'error');
                return;
            }
            
            if (!/^\d+$/.test(cleanedPhone)) {
                showAgentMessage('Phone number should contain only numbers.\n\nPlease enter a valid Malaysian phone number (e.g., 60123456789).', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAgentMessage('Please enter a valid email address.', 'error');
                return;
            }
            
            // Generate Agent ID
            const agentId = generateAgentId(name, cleanedPhone, email);
            
            // Prepare data for submission
            const formData = {
                agentId: agentId,
                name: name,
                phone: cleanedPhone,
                email: email,
                address: address
            };
            
            // Disable submit button
            const submitBtn = document.getElementById('submit-agent-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                // Send data to Google Apps Script
                const response = await submitAgentForm(formData);
                
                if (response.success) {
                    showAgentMessage(`
                        ‚úÖ <strong>Application Submitted Successfully!</strong><br><br>
                        Your Agent ID: <strong>${agentId}</strong><br><br>
                        Please save this ID for future reference.<br>
                        We will contact you within 3 business days.
                    `, 'success');
                    
                    // Reset form after successful submission
                    document.getElementById('agent-form').reset();
                    document.getElementById('agent-id-preview').style.display = 'none';
                    document.getElementById('agent-agree-terms').checked = false;
                } else {
                    throw new Error(response.message || 'Submission failed');
                }
            } catch (error) {
                showAgentMessage(`‚ùå Error: ${error.message}<br>Please try again or contact support.`, 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Submit Application';
            }
        }

        // Submit agent form to Google Apps Script
        async function submitAgentForm(formData) {
            try {
                // Create URL with query parameters
                const url = new URL(AGENT_DATABASE_URL);
                url.searchParams.append('agentId', formData.agentId);
                url.searchParams.append('name', formData.name);
                url.searchParams.append('phone', formData.phone);
                url.searchParams.append('email', formData.email);
                url.searchParams.append('address', formData.address);
                
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                // With no-cors mode, we can't read the response
                return { success: true };
                
            } catch (error) {
                console.error('Agent form submission error:', error);
                throw new Error('Network error. Please check your connection and try again.');
            }
        }

        // Show message in agent form
        function showAgentMessage(message, type) {
            const messageDiv = document.getElementById('agent-message');
            messageDiv.innerHTML = message;
            messageDiv.style.display = 'block';
            messageDiv.style.padding = '15px';
            messageDiv.style.borderRadius = '10px';
            messageDiv.style.marginTop = '20px';
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#d1fae5';
                messageDiv.style.border = '1px solid #10b981';
                messageDiv.style.color = '#065f46';
            } else {
                messageDiv.style.backgroundColor = '#fee2e2';
                messageDiv.style.border = '1px solid #ef4444';
                messageDiv.style.color = '#7f1d1d';
            }
            
            // Auto-hide after 10 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 10000);
            }
        }

        // Initialize agent form
        function initializeAgentForm() {
            const agentForm = document.getElementById('agent-form');
            const cancelBtn = document.getElementById('cancel-agent-btn');
            
            if (agentForm) {
                agentForm.addEventListener('submit', handleAgentSubmit);
                setupAgentFormPreview();
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    document.getElementById('agent-form').reset();
                    document.getElementById('agent-id-preview').style.display = 'none';
                    document.getElementById('agent-message').style.display = 'none';
                    document.getElementById('agent-agree-terms').checked = false;
                });
            }
        }

        // Track Order Functions
        async function trackOrder(orderId) {
            const trackingResults = document.getElementById('tracking-results');
            const trackingLoading = document.getElementById('tracking-loading');
            const trackingError = document.getElementById('tracking-error');
            const orderDetails = document.getElementById('order-details');
            
            // Reset display
            trackingResults.style.display = 'block';
            trackingLoading.style.display = 'block';
            trackingError.style.display = 'none';
            orderDetails.style.display = 'none';
            
            try {
                // Fetch order data from Google Sheets
                const response = await fetch(`${ORDER_DATABASE_URL}?orderId=${encodeURIComponent(orderId)}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch order data');
                }
                
                const data = await response.json();
                
                if (data.success && data.order) {
                    // Order found - update UI
                    updateOrderTracking(data.order);
                    trackingLoading.style.display = 'none';
                    orderDetails.style.display = 'block';
                } else {
                    // Order not found
                    throw new Error(data.message || 'Order ID not found');
                }
                
            } catch (error) {
                trackingLoading.style.display = 'none';
                trackingError.style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
            }
        }

        function updateOrderTracking(orderData) {
            // Update order details
            document.getElementById('order-id-display').textContent = orderData.orderId || '-';
            document.getElementById('customer-name-display').textContent = orderData.customerName || '-';
            document.getElementById('customer-productCode-display').textContent = orderData.productCode || '-';
            document.getElementById('customer-productQuantity-display').textContent = orderData.productQuantity || '-';
            document.getElementById('payment-status-display').textContent = orderData.paymentStatus || '-';
            
            // Determine progress percentage based on logic
            let progressPercent = 0;
            let statusText = '';
            
            // Your logic from requirements:
            // Check Bill Code (Column L)
            if (!orderData.billCode || orderData.billCode === '') {
                // Invalid Order ID
                document.getElementById('order-status-display').textContent = 'Invalid Order ID';
                return;
            } else if (orderData.billCode.toLowerCase().startsWith('pending')) {
                // 0% - Pending Payment
                progressPercent = 10;
                statusText = 'Pending Payment';
            } else if (orderData.paymentStatus === 'paid') {
                // 10% - Payment Received
                progressPercent = 25;
                statusText = 'Payment Received';
                
                // Check Delivery Status (Column M)
                if (orderData.deliveryStatus === 'Notice') {
                    progressPercent = 45;
                    statusText = 'Workers Notice';
                } else if (orderData.deliveryStatus === 'Packing') {
                    progressPercent = 65;
                    statusText = 'Packing Fireworks';
                } else if (orderData.deliveryStatus === 'On Delivery') {
                    progressPercent = 80;
                    statusText = 'On Delivery';
                } else if (orderData.deliveryStatus === 'Complete') {
                    progressPercent = 100;
                    statusText = 'Order Complete';
                }
            } else {
                // Payment not paid but bill code exists
                progressPercent = 0;
                statusText = 'Pending Payment';
            }
            
            // Update status display
            document.getElementById('order-status-display').textContent = statusText;
            
            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${progressPercent}%`;
            
            // Update progress points
            const progressPoints = document.querySelectorAll('.progress-point');
            progressPoints.forEach(point => {
                const pointPercent = parseInt(point.dataset.percent);
                const circle = point.querySelector('.point-circle');
                
                if (pointPercent <= progressPercent) {
                    // Active point
                    circle.style.backgroundColor = 'var(--primary)';
                    circle.style.boxShadow = '0 0 0 3px rgba(249, 115, 22, 0.2)';
                    point.querySelector('span').style.color = 'var(--dark)';
                    point.querySelector('span').style.fontWeight = '600';
                } else {
                    // Inactive point
                    circle.style.backgroundColor = 'var(--gray)';
                    circle.style.boxShadow = 'none';
                    point.querySelector('span').style.color = 'var(--dark-gray)';
                    point.querySelector('span').style.fontWeight = 'normal';
                }
                
                // Highlight current status
                if (pointPercent === progressPercent) {
                    circle.style.transform = 'scale(1.3)';
                    circle.style.boxShadow = '0 0 0 5px rgba(249, 115, 22, 0.3)';
                } else {
                    circle.style.transform = 'scale(1)';
                }
            });
        }

        // Event listener for track order button
        document.addEventListener('DOMContentLoaded', () => {
            const trackOrderBtn = document.getElementById('track-order-btn');
            const orderIdInput = document.getElementById('order-id-input');
            
            if (trackOrderBtn) {
                trackOrderBtn.addEventListener('click', () => {
                    const orderId = orderIdInput.value.trim();
                    if (!orderId) {
                        alert('Please enter your Order ID');
                        return;
                    }
                    
                    // Show tracking section if hidden
                    const trackingResults = document.getElementById('tracking-results');
                    trackingResults.style.display = 'block';
                    
                    trackOrder(orderId);
                });
            }
            
            // Allow pressing Enter in the order ID input
            if (orderIdInput) {
                orderIdInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        trackOrderBtn.click();
                    }
                });
            }
        });
    </script>
</body>
</html>
